#------------------------------------------------------------------------------------------------------------# Project        : Mantis to TCSP Program# Source File    : mantis2tcsp.ps1# Origin Author  : Pakco Kan# Creation Date  : Aug 2017# Version Number : 0.00.01# Modification History :#   Date        By      PCR     Reason#   =========   ======  ======  =================================#   Aug 2017    Pakco Kan       First Creation#------------------------------------------------------------------------------------------------------------#-------------------------------------------Create Log-------------------------------------------------------$Logfile = "D:\Temp\mantis2tcsp_" + (Get-Date -format "yyyyMMddhhmmss") + ".log"$LogStringFunction LogWrite{   Param ([string]$logstring)   Add-content $Logfile -value $logstring}#-------------------------------------------Parameter Setting------------------------------------------------$mantisLogin = "tmo_admin"$mantisPassword = "Abcd1234"$tcspUsername = "cbssupport1" $tcspPassword = "Abcd@1234"#-------------------------------------------Create new TCSP Ticket-------------------------------------------function CreateTCSP() { $ie.navigate("https://tcsp.temenos.com/cqweb/restapi/7.0.0/PACS/RECORD?format=HTML&recordType=Ticket&fieldsXml=<Field><Name>Contact</Name><Value><![CDATA[cbssupport1]]></Value></Field><Field><Name>CustomerCode</Name><Value><![CDATA[CHBL]]></Value></Field><Field><Name>FullDescription</Name><Value><![CDATA[" + (SpecialChar($mantis_full_description)) + "]]></Value></Field><Field><Name>Phone</Name><Value><![CDATA[%2B852%203768%208063]]></Value></Field><Field><Name>SystemStatus</Name><Value><![CDATA[TEST]]></Value></Field><Field><Name>Product</Name><Value><![CDATA[Unknown]]></Value></Field><Field><Name>CustomerReference</Name><Value><![CDATA[" + $mantis_id.PadLeft(7,'0') + "]]></Value></Field>&autoSave=true&loginId=" + $tcspUsername + "&password=" + $tcspPassword + "&noframes=true") while($IE.busy) {Start-Sleep 1} Start-Sleep 15 $ie.document.getElementById("dijit_form_Button_16").click() $full = $ie.document.getElementById("cqShellContainer").outerhtml $td = $full -split '<TD title=Ticket:' $ticket_id = $td[1].Substring(0, 12) $ie.document.getElementById("cq_widget_CqTextBox_2").focus() $ie.document.getElementById("cq_widget_CqTextBox_2").value = $mantis_summary $ie.document.getElementById("cq_widget_CqTextArea_0").focus() $ie.document.getElementById("cq_widget_CqEditableCombo_0").focus() $ie.document.getElementById("cq_widget_CqEditableCombo_0").value = $mantis_product_code $ie.document.getElementById("dijit_form_Button_14_label").click() while($IE.busy) {Start-Sleep 1} Start-Sleep 15 return $ticket_id}#-------------------------------------------Update TCSP Ticket-----------------------------------------------function UpdateTCSP() { $ie.navigate("https://tcsp.temenos.com/cqweb/restapi/7.0.0/PACS/RECORD/" + $mantis_TCSP_ID +  "?format=HTML&recordType=Ticket&action=Modify&fieldsXml=<Field><Name>ShortDescription</Name><Value><![CDATA[" + (SpecialChar($mantis_summary)) + "]]></Value></Field><Field><Name>FullDescription</Name><Value><![CDATA[" + (SpecialChar($mantis_full_description)) + "]]></Value></Field>&autoSave=true&loginId=" + $tcspUsername + "&password=" + $tcspPassword + "&noframes=true") while($IE.busy) {Start-Sleep 1} Start-Sleep 15 return GetTCSPStatus}#-------------------------------------------Update Mantis from TCSP-------------------------------------------function GetTCSPStatus() { $ie.navigate("https://tcsp.temenos.com/cqweb/restapi/7.0.0/PACS/RECORD/" + $mantis_TCSP_ID +  "?format=HTML&recordType=Ticket&loginId=" + $tcspUsername + "&password=" + $tcspPassword + "&noframes=true") while($IE.busy) {Start-Sleep 1} Start-Sleep 15 for($i=0;$i -lt 10;$i++){  if($ie.document.getElementById("cq_widget_CqTextBox_$i").value){   $returnStatus = $ie.document.getElementById("cq_widget_CqTextBox_$i").value  } } return $returnStatus}#-------------------------------------------Update Product Code from TCSP-------------------------------------------function GetProductCode() { $ie.navigate("https://tcsp.temenos.com/cqweb/restapi/7.0.0/PACS/RECORD/" + $mantis_TCSP_ID +  "?format=HTML&recordType=Ticket&loginId=" + $tcspUsername + "&password=" + $tcspPassword + "&noframes=true") while($IE.busy) {Start-Sleep 1} Start-Sleep 15  $returnPC = $ie.document.getElementById("cq_widget_CqEditableCombo_0").value return $returnPC}#-------------------------------------------Special characher handling----------------------------------------function SpecialChar($input_text) { $input_text = $input_text -replace "\`%", '' $input_text = $input_text -replace "\` ", '%20' $input_text = $input_text -replace "\`@", '' $input_text = $input_text -replace "\`#", '' $input_text = $input_text -replace "\`$", '' $input_text = $input_text -replace "\`^", '' $input_text = $input_text -replace "\`&", '' $input_text = $input_text -replace "\`+", '' $input_text = $input_text -replace "\`{", '' $input_text = $input_text -replace "\`}", '' $input_text = $input_text -replace "\`:", '' $input_text = $input_text -replace "\`"", '' $input_text = $input_text -replace "\`<", '' $input_text = $input_text -replace "\`>", '' $input_text = $input_text -replace "\`?", '' $input_text = $input_text -replace "\`[", '' $input_text = $input_text -replace "\`]", '' $input_text = $input_text -replace "\`;", '' $input_text = $input_text -replace "\`,", '' $input_text = $input_text -replace "\`/", '' $input_text = $input_text -replace "\`|", '' $input_text = $input_text -replace "\`\", '' $input_text = $input_text -replace "\`t", '' return $input_text}#-------------------------------------------Main-------------------------------------------------------------#Login to TCSP$ie = New-Object -com InternetExplorer.Application$ie.visible=$true$ie.navigate("https://tcsp.temenos.com")while($IE.busy) {Start-Sleep 1}Start-Sleep 15try{$ie.document.getElementById("username").value = "$tcspUsername"}catch{""}try{$ie.document.getElementById("password").value = "$tcspPassword"}catch{""}try{$ie.document.getElementById("submitButton").click()}catch{"already login"}while($IE.busy) {Start-Sleep 1}$ie.navigate("https://tcsp.temenos.com/SitePages/T24Intelligence.aspx")while($IE.busy) {Start-Sleep 1}Start-Sleep 15$ie.navigate("https://tcsp.temenos.com/SitePages/TicketingSystem.aspx")while($IE.busy) {Start-Sleep 1}Start-Sleep 15$ie.navigate("https://tcsp.temenos.com/cqweb/#/7.0.0/PACS&format=HTML&loginId=cbssupport1&password=&version=cqwj", 2048)while($IE.busy) {Start-Sleep 1}Start-Sleep 15#Create a web service for Mantis$mantis = New-WebServiceProxy -Uri "http://mtbtdev01.chbank.com/mantisbt/api/soap/mantisconnect.php?wsdl" -Namespace WebServiceProxy#Get project list and corresponding custom fields$mantis_project = $mantis.mc_projects_get_user_accessible("$mantisLogin","$mantisPassword")for($i=0;$i -lt $mantis_project.length;$i++){ LogWrite '' LogWrite '************************************************' $mantisUpdateCount = 0 $tcspUpdateCount = 0 $tcspCreateCount = 0 $LogString = 'Project ' + $mantis_project[$i].id + '   ' + $mantis_project[$i].name LogWrite $LogString $mantis_custom = $mantis.mc_project_get_custom_fields("$mantisLogin","$mantisPassword",$mantis_project[$i].id) $cf_tcsp_return_error = $null $cf_tcsp_ticket_id = $null $cf_tick_to_update_tcsp = $null $cf_tcsp_ticket_status = $null $cf_tcsp_last_sync_date = $null $cf_fsd_reference = $null $cf_tcsp_product_code = $null for($j=0;$j -lt $mantis_custom.length;$j++){  $LogString = "$j" + ' : ' + $mantis_custom[$j].field.name  LogWrite $LogString  if($mantis_custom[$j].field.name -eq 'TCSP Return Error'){$cf_tcsp_return_error = $j}  if($mantis_custom[$j].field.name -eq 'TCSP Ticket ID'){$cf_tcsp_ticket_id = $j}  if($mantis_custom[$j].field.name -eq 'Tick to Update TCSP'){$cf_tick_to_update_tcsp = $j}  if($mantis_custom[$j].field.name -eq 'TCSP Ticket Status'){$cf_tcsp_ticket_status = $j}  if($mantis_custom[$j].field.name -eq 'TCSP Last Sync Date'){$cf_tcsp_last_sync_date = $j}  if($mantis_custom[$j].field.name -eq 'FSD Reference'){$cf_fsd_reference = $j}  if($mantis_custom[$j].field.name -eq 'TCSP Product Code'){$cf_tcsp_product_code = $j} } #Loop for each project $mantis_issue = $mantis.mc_project_get_issues("$mantisLogin","$mantisPassword",$mantis_project[$i].id,"","") #Do if the custom fields are exist in this project if("$cf_tcsp_return_error" -And "$cf_tcsp_ticket_id" -And "$cf_tick_to_update_tcsp" -And "$cf_tcsp_ticket_status" -And "$cf_tcsp_last_sync_date" -And "$cf_fsd_reference" -And "$cf_tcsp_product_code"){  $LogString = 'Loop for project' + $mantis_project[$i].id  LogWrite $LogString  #Repeat for every mantis id  for($k=0; $k -lt $mantis_issue.Length; $k++) {   #Clear Variable   $mantis_TickToUpdateTCSP = $null   $mantis_id = $null   $mantis_TCSP_ID = $null   $mantis_summary = $null   $mantis_description = $null   $mantis_steps_to_reproduce = $null   $mantis_full_description = $null   $tcsp_ticket_id = $null   $tcsp_status = $null   $mantis_tcsp_ticket_status = $null   $mantis_fsd_reference = $null   $mantis_full_summary = $null   $mantis_product_code = $null   $tcsp_product_code = $null   #check if tick to update TCSP   if($mantis_issue[$k].custom_fields[$cf_tick_to_update_tcsp].value){$mantis_TickToUpdateTCSP = $mantis_issue[$k].custom_fields[$cf_tick_to_update_tcsp].value.trim(" ")}   if($mantis_issue[$k].id){$mantis_id = $mantis_issue[$k].id.trim(" ")}   if($mantis_issue[$k].custom_fields[$cf_tcsp_ticket_id].value){$mantis_TCSP_ID = $mantis_issue[$k].custom_fields[$cf_tcsp_ticket_id].value.trim(" ")}   if($mantis_issue[$k].custom_fields[$cf_tcsp_ticket_status].value){$mantis_tcsp_ticket_status = $mantis_issue[$k].custom_fields[$cf_tcsp_ticket_status].value.trim(" ")}   $tcsp_ticket_id = $mantis_TCSP_ID   if($mantis_issue[$k].summary){$mantis_summary = $mantis_issue[$k].summary.trim(" ")}   if($mantis_issue[$k].description){$mantis_description = $mantis_issue[$k].description.trim(" ")}   if($mantis_issue[$k].steps_to_reproduce){$mantis_steps_to_reproduce = $mantis_issue[$k].steps_to_reproduce.trim(" ")}   if($mantis_issue[$k].custom_fields[$cf_fsd_reference].value){$mantis_fsd_reference = $mantis_issue[$k].custom_fields[$cf_fsd_reference].value.trim(" ")}   if($mantis_issue[$k].custom_fields[$cf_tcsp_product_code].value){$mantis_product_code = $mantis_issue[$k].custom_fields[$cf_tcsp_product_code].value.trim(" ")}   $mantis_full_description = $mantis_description + ' ' + $mantis_steps_to_reproduce   $mantis_full_summary = $mantis_fsd_reference + ': ' + $mantis_summary   LogWrite ''   LogWrite '------------------------------------------------'   LogWrite ''   $LogString =  'mantis_id = ' +  $mantis_id   LogWrite $LogString   $LogString =  'mantis_TickToUpdateTCSP = ' + $mantis_TickToUpdateTCSP   LogWrite $LogString   $LogString =  'mantis_summary = ' +  $mantis_summary   LogWrite $LogString   $LogString =  'mantis_full_description = ' +  $mantis_full_description   LogWrite $LogString   $LogString =  'tcsp_ticket_id = ' +  $tcsp_ticket_id   LogWrite $LogString   $LogString =  'mantis_original_tcsp_status = ' +  $mantis_tcsp_ticket_status   LogWrite $LogString   $LogString =  'mantis_original_product_code = ' +  $mantis_product_code   LogWrite $LogString   if($mantis_TickToUpdateTCSP -eq "Yes"){    if($mantis_TCSP_ID)     {$tcsp_status = UpdateTCSP      $LogString =  $tcsp_ticket_id + " updated"      LogWrite $LogString      $tcsp_product_code = GetProductCode      $LogString =  $tcsp_product_code + " updated"      LogWrite $LogString      $LogString =  'Status retrieved: ' + $tcsp_status      LogWrite $LogString      $tcspUpdateCount++      $mantisUpdateCount++}    else     {$tcsp_ticket_id = CreateTCSP      $tcsp_status = "ContactMade"      $LogString = $tcsp_ticket_id + " created"      LogWrite $LogString      $tcspCreateCount++      $mantisUpdateCount++}   }   else{    if($mantis_TCSP_ID)     {$tcsp_status = GetTCSPStatus      $tcsp_product_code = GetProductCode      $LogString =  'tcsp_product_code = ' +  $tcsp_product_code      LogWrite $LogString      if($mantis_tcsp_ticket_status -ne $tcsp_status -Or $mantis_product_code -ne $tcsp_product_code){$mantisUpdateCount++}}    else     {continue}   }   $LogString = 'latest_tcsp_status = ' +  $tcsp_status   LogWrite $LogString   #check whether the tcsp ticket id retrieved is correct. Unless user tick to update TSCP, otherwise update mantis only when tcsp status change   if($tcsp_ticket_id.substring(0,4) -eq "PACS"){    if($mantis_tcsp_ticket_status -ne $tcsp_status -Or $mantis_product_code -ne $tcsp_product_code -Or $mantis_TickToUpdateTCSP -eq "Yes"){     $mantis_issue[$k].custom_fields[$cf_tcsp_ticket_id].value = $tcsp_ticket_id     $mantis_issue[$k].custom_fields[$cf_tick_to_update_tcsp].value = "No"     $mantis_issue[$k].custom_fields[$cf_tcsp_ticket_status].value = $tcsp_status     $mantis_issue[$k].custom_fields[$cf_tcsp_last_sync_date].value = Get-Date -Format g     $mantis_issue[$k].custom_fields[$cf_tcsp_product_code].value = $tcsp_product_code     $mantis.mc_issue_update($mantisLogin,$mantisPassword,$mantis_id,$mantis_issue[$k])     $LogString = "***mantis: " + $mantis_id + " - " + "TCSP: " + $tcsp_ticket_id + " updated***"     LogWrite $LogString    }   }   else{    LogWrite 'Error occur when retrieving TCSP ID'   }  } } $LogString = 'Number of records updated in Mantis: ' + $mantisUpdateCount LogWrite $LogString $LogString = 'Number of records created in TCSP: ' + $tcspCreateCount LogWrite $LogString $LogString = 'Number of records updated in TCSP: ' + $tcspUpdateCount LogWrite $LogString LogWrite '************************************************' LogWrite ''}$ie.quit()
